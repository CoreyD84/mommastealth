name: Build and Release MommaStealth APK

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'mommastealth/**'
      - '.github/workflows/build-mommastealth.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build MommaStealth Release APK
        run: ./gradlew :mommastealth:assembleRelease

      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: mommastealth/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      - name: Rename APK
        run: |
          mv ${{steps.sign_app.outputs.signedReleaseFile}} mommastealth/build/outputs/apk/release/mommastealth-release.apk

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: mommastealth-apk
          path: mommastealth/build/outputs/apk/release/mommastealth-release.apk

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: mommastealth-v${{ github.run_number }}
          release_name: MommaStealth v${{ github.run_number }}
          body: |
            Automated release of MommaStealth child app

            ## Installation Instructions
            1. Download the APK file below
            2. Enable "Install from Unknown Sources" on your Android device
            3. Install the APK
            4. Scan the QR code from the guardian app to link devices
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: mommastealth/build/outputs/apk/release/mommastealth-release.apk
          asset_name: mommastealth-release.apk
          asset_content_type: application/vnd.android.package-archive
